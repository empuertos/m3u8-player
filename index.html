// worker.js -- Cloudflare Worker (ES Module)
const HLS_SOURCE = 'http://playertest.longtailvideo.com/adaptive/wowzaid3/playlist.m3u8';

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // Proxy the .m3u8 (so the page can avoid some CORS/mixed-content issues if needed)
    if (url.pathname === '/proxy.m3u8') {
      // Simple passthrough proxy
      const upstream = HLS_SOURCE;
      const resp = await fetch(upstream);
      // Copy headers but ensure CORS
      const headers = new Headers(resp.headers);
      headers.set('Access-Control-Allow-Origin', '*');
      headers.set('Content-Type', 'application/vnd.apple.mpegurl');
      return new Response(resp.body, {
        status: resp.status,
        headers
      });
    }

    // Serve HTML page with Video.js player
    if (url.pathname === '/' || url.pathname === '/index.html') {
      const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Cloudworker Video.js HLS Player</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://vjs.zencdn.net/8.0.0/video-js.css" rel="stylesheet"/>
<style>
  body{margin:0;background:#0f111a;color:#fff;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;display:flex;flex-direction:column;align-items:center;padding:1rem;}
  .player-container{width:100%;max-width:960px;}
  h1{margin:0 0 .5rem;font-size:1.5rem;text-align:center;}
  .info{font-size:.85rem;margin-top:.5rem;word-break:break-all;opacity:.9;}
  .error{margin-top:.5rem;background:#b33;padding:8px;border-radius:6px;font-size:.85rem;}
</style>
</head>
<body>
  <h1>Video.js VHS HLS Player (via Cloudflare Worker)</h1>
  <div class="player-container">
    <video id="player" class="video-js vjs-big-play-centered" controls preload="auto" playsinline data-setup='{}' style="width:100%;border-radius:10px;">
      <p class="vjs-no-js">Enable JavaScript to view the player.</p>
    </video>
    <div class="info">
      Playing manifest proxied at <code>/proxy.m3u8</code> (original: ${HLS_SOURCE})
    </div>
    <div id="error-box" aria-live="polite"></div>
  </div>

  <script src="https://vjs.zencdn.net/8.0.0/video.min.js"></script>
  <script>
    (function(){
      const manifest = location.origin + '/proxy.m3u8'; // proxied to avoid CORS/mixed issues
      const player = videojs('player', {
        fluid: true,
        liveui: true,
        autoplay: false,
        html5: {
          hls: {
            overrideNative: false
          }
        }
      });

      function showError(msg){
        const box = document.getElementById('error-box');
        box.innerHTML = '';
        const d = document.createElement('div');
        d.className = 'error';
        d.textContent = msg;
        box.appendChild(d);
      }

      player.src({ src: manifest, type: 'application/x-mpegURL' });

      player.on('error', () => {
        const e = player.error();
        console.warn('Playback error:', e);
        showError(e && e.message ? 'Playback error: ' + e.message : 'Unknown error');
      });

      player.on('loadedmetadata', () => {
        console.log('Loaded metadata, duration:', player.duration());
      });
    })();
  </script>
</body>
</html>`;
      return new Response(html, {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    }

    // Fallback 404
    return new Response('Not found', { status: 404 });
  }
}
